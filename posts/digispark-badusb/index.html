<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="hare"><link rel=prev href=https://hare001.github.io/posts/curl-cheat-sheet/><link rel=next href=https://hare001.github.io/posts/ydkb-hhkb-ble-mod/><link rel=canonical href=https://hare001.github.io/posts/digispark-badusb/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Digispark BadUSB | WhereIsMyMind</title><meta name=title content="Digispark BadUSB | WhereIsMyMind"><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/hare001.github.io"},"articleSection":"posts","name":"Digispark BadUSB","headline":"Digispark BadUSB","description":"\u003cp\u003e最近闲着无聊，本着生命在于折腾的本质，用 Digispark 做个 BadUSB 玩玩。\u003c\/p\u003e\n\u003cp\u003eDigispark 长这样：\u003c\/p\u003e\n\u003cp\u003e\u003cimg src=\u0022https:\/\/s3.amazonaws.com\/digistump-resources\/images\/l\/2520dcf84a0a3bf2257c2559d7a187db.jpg\u0022 alt=\u0022Digispark\u0022 style=\u0022zoom:50%;\u0022 \/\u003e\u003c\/p\u003e\n\u003cp\u003e简单介绍下 Digispark 这个小玩意儿：\u003c\/p\u003e\n\u003cp\u003eDigispark USB Development Board 是一块基于 ATTiny85 微控制器的开发板，便宜小巧携带方便，某宝上十块包邮，相比于 BadUSB 的老前辈 USB Rubber Ducky  简直是便宜到家了好吗，性价比真的超高。\u003cspan class=\u0022spoiler\u0022 \u003e\u003cdel\u003e绝不承认不买 Rubber Ducky 是没钱，哼！\u003c\/del\u003e\u003c\/span\u003e\u003c\/p\u003e\n\u003cp\u003e关于 BadUSB，网上很多人都觉得只是含有有害程序的 U 盘，并以为可以通过格式化、禁止 U 盘自启动来阻止 BadUSB 的攻击。但其实它更像是没有按键的键盘，靠着烧录进去的程序来模拟人类输入，计算机是无法识别出 BadUSB 和人类正常输入的区别的。所以大家记得一定不要随便在自己或公司的电脑上插来历不明的 U 盘！\u003c\/p\u003e","inLanguage":"en","author":"hare","creator":"hare","publisher":"hare","accountablePerson":"hare","copyrightHolder":"hare","copyrightYear":"2020","datePublished":"2020-07-26 22:30:29 \u002b0800 \u002b0800","dateModified":"2020-07-26 22:30:29 \u002b0800 \u002b0800","url":"https:\/\/hare001.github.io\/posts\/digispark-badusb\/","wordCount":"1730","keywords":["生命在于折腾","BadUSB","Security","Arduino","WhereIsMyMind"]}</script></head><body><div class=wrapper><head><meta charset=utf-8><title>Digispark BadUSB</title><link href=/css/fontawesome-all.min.css?1596526873 rel=stylesheet></head><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-back2home-logo"><span class=logo_mark>#</span>
<a href=https://hare001.github.io><span class=logo_text>cd /home/</span>
<span class=logo_cursor></span></a></div><div class=navbar-right><span class=menu><a class=menu-item href=/posts/><span>Blog</span></a>
<a class=menu-item href=/categories/><span>Category</span></a>
<a class=menu-item href=/tags/><span>Tag</span></a>
<a class=menu-item href=/index.xml><i class="fa fa-rss"></i><span></span></a><span class=divide></span><a href=javascript:void(0); class=theme-switch><i class="fa fa-adjust"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://hare001.github.io>WhereIsMyMind</a></div><div class=navbar-right><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=/posts/><h3>Blog</h3><div class=menu-active></div></a><a class=menu-item href=/categories/><h3>Category</h3><div class=menu-active></div></a><a class=menu-item href=/tags/><h3>Tag</h3><div class=menu-active></div></a><a class=menu-item href=/index.xml><h3></h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">Digispark BadUSB</h1><div class=post-meta>Written by <a itemprop=name href=https://hare001.github.io rel=author>hare</a>
<span class=post-time>on <time datetime=2020-07-26 itemprop=datePublished>July 26, 2020</time></span>
in
<i class="fa fa-folder"></i><span class=post-category><a href=https://hare001.github.io/categories/%E7%94%9F%E5%91%BD%E5%9C%A8%E4%BA%8E%E6%8A%98%E8%85%BE/>生命在于折腾,</a></span>
<span class=post-word-count>1730 words</span></div></header><div class=post-content><p>最近闲着无聊，本着生命在于折腾的本质，用 Digispark 做个 BadUSB 玩玩。</p><p>Digispark 长这样：</p><p><img src=https://s3.amazonaws.com/digistump-resources/images/l/2520dcf84a0a3bf2257c2559d7a187db.jpg alt=Digispark style=zoom:50%></p><p>简单介绍下 Digispark 这个小玩意儿：</p><p>Digispark USB Development Board 是一块基于 ATTiny85 微控制器的开发板，便宜小巧携带方便，某宝上十块包邮，相比于 BadUSB 的老前辈 USB Rubber Ducky 简直是便宜到家了好吗，性价比真的超高。<span class=spoiler><del>绝不承认不买 Rubber Ducky 是没钱，哼！</del></span></p><p>关于 BadUSB，网上很多人都觉得只是含有有害程序的 U 盘，并以为可以通过格式化、禁止 U 盘自启动来阻止 BadUSB 的攻击。但其实它更像是没有按键的键盘，靠着烧录进去的程序来模拟人类输入，计算机是无法识别出 BadUSB 和人类正常输入的区别的。所以大家记得一定不要随便在自己或公司的电脑上插来历不明的 U 盘！</p><h3 id=配置-digispark-开发环境>配置 Digispark 开发环境</h3><p>要使用 Digispark 制作 BadUSB，首先我们要安装开发环境，在这里选择 Arduino。我的开发环境是 macOS，所以后续介绍以 macOS 为准。</p><p>可以在 <a href=https://www.arduino.cc/>Arduino</a> 官网上选择适配自己开发环境的安装版本。</p><p>安装好 Arduino 后，在 <strong>Preferences</strong> -> <strong>Additional Boards Manager URLs</strong> 处输入：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#960050;background-color:#1e0010>http://digistump.com/package_digistump_index.json
</span></code></pre></div><p>接下来在 <strong>Tools</strong> -> <strong>Board</strong> -> <strong>Boards Manager</strong>，安装 <strong>Digistump AVR Boards</strong> 包。
等待安装好，选择 <strong>Tools</strong> -> <strong>Board</strong> -> <strong>Digistump AVR Boards</strong> -> <strong>Digispark(Default - 16.5 Mhz)</strong>，此时 Arduino IDE 就可以成功识别 Digispark 开发板了。<span class=spoiler><del>居然没有出现驱动方面的问题，撒花</del></span></p><h3 id=编写一份-helloworld-吧>编写一份 helloworld 吧！</h3><p>既然是第一次玩 Digispark 开发板，怎么能不写一份 hello world 呢：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;DigiKeyboard.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
  <span style=color:#75715e>// put your setup code here, to run once:
</span><span style=color:#75715e></span>  DigiKeyboard.sendKeyStroke(<span style=color:#ae81ff>0</span>);
  DigiKeyboard.delay(<span style=color:#ae81ff>2000</span>);
  DigiKeyboard.sendKeyStroke(KEY_R, MOD_GUI_LEFT); <span style=color:#75715e>//GUI 键在 macOS 下是 ⌘ 键，在 Windows 下是徽标键
</span><span style=color:#75715e></span>  DigiKeyboard.delay(<span style=color:#ae81ff>300</span>);
  DigiKeyboard.println(<span style=color:#e6db74>&#34;notepad&#34;</span>);
  DigiKeyboard.delay(<span style=color:#ae81ff>300</span>);
  DigiKeyboard.sendKeyStroke(KEY_ENTER);
  DigiKeyboard.delay(<span style=color:#ae81ff>300</span>);
  DigiKeyboard.println(<span style=color:#e6db74>&#34;hello, world!&#34;</span>);
  DigiKeyboard.delay(<span style=color:#ae81ff>300</span>);
}
<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loop</span>() {
  <span style=color:#75715e>// put your main code here, to run repeatedly: 
</span><span style=color:#75715e></span>}
</code></pre></div><p>点击 Verify 验证一下代码以防出错，然后就……报错了……</p><p>此处 Error 信息：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext>fork/exec ~/Library/Arduino15/packages/arduino/tools/avr-gcc/4.8.1-arduino5/bin/avr-g++: bad CPU type in executable
Error compiling for board Digispark (Default - 16.5mhz).
</code></pre></div><p>STFW 找到了原因：从 macOS Catalina 开始，不再支持 32 位程序，所以需要替换掉 Digispark 自带的 32 位 AVR 编译工具。</p><p>在 terminal 里运行：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cd ~/Library/Arduino15/packages/arduino/tools/avr-gcc
mv 4.8.1-arduino5 orig.4.8.1
ln -s /Applications/Arduino.app/Contents/Java/hardware/tools/avr 4.8.1-arduino5
</code></pre></div><p>再次验证，提示已经成功编译。</p><h3 id=烧录代码>烧录代码</h3><p>现在就可以上传代码到硬件上了，点击 <strong>Upload</strong>，在 60 秒内插入 Digispark 开发板完成上传。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Running Digispark Uploader...
Plug in device now... <span style=color:#f92672>(</span>will timeout in <span style=color:#ae81ff>60</span> seconds<span style=color:#f92672>)</span>
&gt; Please plug in the device ... 
&gt; Press CTRL+C to terminate the program.
&gt; Device is found!
connecting: 16% complete
connecting: 22% complete
connecting: 28% complete
connecting: 33% complete
&gt; Device has firmware version 2.2
&gt; Device signature: 0x1e930b 
&gt; Available space <span style=color:#66d9ef>for</span> user applications: <span style=color:#ae81ff>6522</span> bytes
&gt; Suggested sleep time between sending pages: 7ms
&gt; Whole page count: <span style=color:#ae81ff>102</span>  page size: <span style=color:#ae81ff>64</span>
&gt; Erase <span style=color:#66d9ef>function</span> sleep duration: 714ms
parsing: 50% complete
&gt; Erasing the memory ...
erasing: 55% complete
erasing: 60% complete
erasing: 65% complete
&gt; Starting to upload ...
writing: 70% complete
writing: 75% complete
writing: 80% complete
&gt; Starting the user app ...
running: 100% complete
&gt;&gt; Micronucleus <span style=color:#66d9ef>done</span>. Thank you!
</code></pre></div><p>我们将板子插入<span class=spoiler><del>受害者</del></span>朋友的 Windows 设备上，就可以看到运行 notepad 并输出 hello world 了。</p><h3 id=更进一步>更进一步</h3><p>现在我们可以尝试自己写一个 payload 了。</p><p>其实利用 BadUSB 的攻击过程，就是将 Digispark 开发板伪装成为一个 HID（Human Interface Device）。</p><pre><code class=language-wiki data-lang=wiki>HID（Human Interface Device）人机接口设备类别是 Windows 最早支持的USB类别。由其名称可以了解 HID 设备是计算机直接
与人交互的设备，例如键盘、鼠标和游戏杆等。不过 HID 设备不一定要有人机接口，只要符合 HID 类别规范，就都是 HID 设备。
</code></pre><p>我们可以通过添加、修改注册表项，下载执行脚本，执行命令，结束进程等达到一系列我们想要实现的结果。
现在网上给 BadUSB 准备的脚本多为给 Rubber Ducky 准备的，还好我们可以进行转换，其实原理都是一样的，只不过实现代码不同。
Rubber Ducky 的代码长这样：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bat data-lang=bat>DELAY 600
<span style=color:#75715e>REM Linux run dialog</span>
ALT F2
DELAY 200
<span style=color:#75715e>REM Mac OS run dialog</span>
GUI SPACE
DELAY 200
<span style=color:#75715e>REM On Windows this changes the input language, so press 3 times</span>
GUI SPACE
DELAY 200
GUI SPACE
DELAY 200
GUI r
DELAY 200
<span style=color:#75715e>REM On another OS, this could have typed &#34;   r&#34;. Backspace 4 times.</span>
DELETE
REPEAT 4
<span style=color:#75715e>REM Type in URL and open page!</span>
STRING http://example.com/
ENTER
</code></pre></div><p>以上脚本是模拟键盘在各种操作系统上的打开指定网页的操作。</p><p>可以使用 <a href=https://nixu-corp.github.io/>dckunio.js</a> 来在线转换，也可以使用 <a href=https://github.com/mame82/duck2spark>duck2spark</a> 脚本来进行转换。</p><p>上面的脚本转换好了长这样：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/*
</span><span style=color:#75715e> * Generated with &lt;3 by Dckuino.js, an open source project !
</span><span style=color:#75715e> */</span>

<span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;avr/pgmspace.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;DigiKeyboard.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> line1[] PROGMEM <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://example.com/&#34;</span>;

<span style=color:#66d9ef>char</span> buffer[<span style=color:#ae81ff>256</span>];

<span style=color:#75715e>#define GetPsz(x) (strncpy_P(buffer, (char*)x, 256))
</span><span style=color:#75715e>#define KEY_UP_ARROW		0x52
</span><span style=color:#75715e>#define KEY_DOWN_ARROW	0x51
</span><span style=color:#75715e>#define KEY_LEFT_ARROW		0x50
</span><span style=color:#75715e>#define KEY_RIGHT_ARROW		0x4F
</span><span style=color:#75715e>#define KEY_LEFT_GUI			0xE3
</span><span style=color:#75715e>#define KEY_ESC				0x29
</span><span style=color:#75715e>#define KEY_TAB				0x2B
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>digiBegin</span>() {
  DigiKeyboard.sendKeyStroke(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>);
  DigiKeyboard.delay(<span style=color:#ae81ff>50</span>);
}

<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>digiEnd</span>() {
  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> led<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
  pinMode(led, OUTPUT);
  <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>) {
    digitalWrite(led, <span style=color:#f92672>!</span>digitalRead(led));
    DigiKeyboard.delay(<span style=color:#ae81ff>1000</span>);
  }
}

<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>printText</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>txt) {
  DigiKeyboard.print(txt);
  DigiKeyboard.update();
}

<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setup</span>() {
  digiBegin();

  DigiKeyboard.delay(<span style=color:#ae81ff>600</span>);

  <span style=color:#75715e>// Linux run dialog
</span><span style=color:#75715e></span>  DigiKeyboard.sendKeyStroke(KEY_F2,MOD_ALT_LEFT);

  DigiKeyboard.delay(<span style=color:#ae81ff>200</span>);

  <span style=color:#75715e>// Mac OS run dialog
</span><span style=color:#75715e></span>  DigiKeyboard.sendKeyStroke(KEY_SPACE,MOD_GUI_LEFT);

  DigiKeyboard.delay(<span style=color:#ae81ff>200</span>);

  <span style=color:#75715e>// On Windows this changes the input language, so press 3 times
</span><span style=color:#75715e></span>  DigiKeyboard.sendKeyStroke(KEY_SPACE,MOD_GUI_LEFT);

  DigiKeyboard.delay(<span style=color:#ae81ff>200</span>);

  DigiKeyboard.sendKeyStroke(KEY_SPACE,MOD_GUI_LEFT);

  DigiKeyboard.delay(<span style=color:#ae81ff>200</span>);

  DigiKeyboard.sendKeyStroke(KEY_R,MOD_GUI_LEFT);

  DigiKeyboard.delay(<span style=color:#ae81ff>200</span>);

  <span style=color:#75715e>// On another OS, this could have typed &#34;   r&#34;. Backspace 4 times.
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>; i<span style=color:#f92672>++</span>) {
    DigiKeyboard.sendKeyStroke(KEY_DELETE);
  }

  <span style=color:#75715e>// Type in URL and open page!
</span><span style=color:#75715e></span>  <span style=color:#75715e>// http://example.com/
</span><span style=color:#75715e></span>  printText(GetPsz(line1));

  DigiKeyboard.sendKeyStroke(KEY_ENTER);

  digiEnd();

}
<span style=color:#75715e>/* Unused endless loop */</span>
<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loop</span>() {}
</code></pre></div><p>首次烧录完，插入受攻击的设备没能正常实现功能，可能是驱动问题（部分情况耐心等待即可）、中文输入法问题（可以通过大写锁定键进行绕过）、不同操作系统快捷功能键不同，找到出现问题的步骤进行调试即可。</p><p>如果不会编写 Rubber Ducky 脚本或者 Digispark 脚本，可以根据自己的攻击思路在 <a href=https://www.ducktoolkit.com/>DuckToolkit</a> 生成 Rubber Ducky 的 Payload，然后进行转换即可。</p><p>另外，Digispark 开发版元件都是直接暴露出来的，这样容易造成短路等物理损坏。可以用热缩管将开发板隔离一下，或者是 3D 打印个 U 盘的外壳来进行伪装。用这个来做 BadUSB 搞社工成本还是很低的，只要在目标公司附近摆个「扫码领 U 盘」的活动就可以了，毕竟人才是最脆弱的安全系统。</p><p>参考：</p><p><a href=https://www.ducktoolkit.com/>Duck Toolkit</a></p><p><a href=https://github.com/hak5darren/USB-Rubber-Ducky>USB-Rubber-Ducky</a></p><p><a href=https://github.com/hak5darren/USB-Rubber-Ducky/wiki/Payloads>USB-Rubber-Ducky-Payloads</a></p><p><a href=https://github.com/mame82/duck2spark>duck2spark</a></p><p><a href=https://nixu-corp.github.io/>dckunio.js</a></p><p><a href=https://github.com/CedArctic/DigiSpark-Scripts>DigiSpark-Scripts</a></p></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>hare</span></p><p class=copyright-item><span>Link:</span>
<a href=https://hare001.github.io/posts/digispark-badusb/>https://hare001.github.io/posts/digispark-badusb/</span></p><p class="copyright-item lincese">本文采用<a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p></div><div class=post-tags><section><i class="fa fa-bookmark"></i>Tag(s):
<span class=tag><a href=https://hare001.github.io/tags/%E7%94%9F%E5%91%BD%E5%9C%A8%E4%BA%8E%E6%8A%98%E8%85%BE/>#生命在于折腾</a></span>
<span class=tag><a href=https://hare001.github.io/tags/badusb/>#BadUSB</a></span>
<span class=tag><a href=https://hare001.github.io/tags/security/>#Security</a></span>
<span class=tag><a href=https://hare001.github.io/tags/arduino/>#Arduino</a></span></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://hare001.github.io>home</a></span></section></div><div class=post-nav><a href=https://hare001.github.io/posts/curl-cheat-sheet/ class=prev rel=prev title="Curl Cheat Sheet"><i class="fa fa-chevron-left"></i>&nbsp;Curl Cheat Sheet</a>
<a href=https://hare001.github.io/posts/ydkb-hhkb-ble-mod/ class=next rel=next title="YDKB HHKB BLE Mod">YDKB HHKB BLE Mod&nbsp;<i class="fa fa-chevron-right"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2020 - 2020</span>
<span class=author itemprop=copyrightHolder><a href=https://hare001.github.io>hare</a> |</span>
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/Mogeko/Mogege target=_blank rel="external nofollow">Mogege</a></span></div></footer><script defer src=/js/vendor_main.min.js></script><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script>pangu.spacingPage();</script></div></body></html>